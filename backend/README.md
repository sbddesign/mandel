# Mandel Backend - Cashu Mint

This directory contains the backend configuration for the Mandel ecash wallet, using the Cashu mint server with LDK Node Lightning backend.

## Quick Start

1. **Copy environment file:**
   ```bash
   cp env.example .env
   ```

2. **Generate a mint private key (if needed):**
   ```bash
   python3 -c "import secrets; print('MINT_PRIVATE_KEY=' + secrets.token_hex(32))" >> .env
   ```

3. **Start the mint server:**
   ```bash
   docker compose up -d
   ```

4. **Check if the server is running:**
   ```bash
   curl http://localhost:3338/v1/info
   ```

5. **Access LDK Node management interface:**
   - **Local development**: http://localhost:8091
   - **Production (Render)**: Use SSH tunnel or management proxy (see below)

## Configuration

The mint server uses the CDK mintd with LDK Node Lightning backend. Key configuration:

- **Lightning Backend**: LDK Node (MutinyNet Signet)
- **Database**: SQLite (persistent)
- **Mint API Port**: 3338
- **LDK Node Management**: 8091
- **Network**: MutinyNet Signet via Esplora
- **Mnemonic**: Default test mnemonic (change for production)

The server automatically generates a private key and mnemonic if not provided in the `.env` file.

## API Endpoints

The mint server exposes the following main endpoints:

- `GET /v1/info` - Get mint information
- `POST /v1/mint/bolt11` - Mint new ecash tokens (Bolt11)
- `POST /v1/mint/bolt12` - Mint new ecash tokens (Bolt12)
- `POST /v1/melt/bolt11` - Melt ecash tokens (Bolt11)
- `POST /v1/melt/bolt12` - Melt ecash tokens (Bolt12)
- `POST /v1/swap` - Swap tokens
- `POST /v1/check` - Check if tokens are valid

## Development

### Viewing Logs
```bash
docker compose logs -f mintd
```

### Stopping the Server
```bash
docker compose down
```

### Restarting the Server
```bash
docker compose restart mintd
```

### Database Persistence

The mint database is persisted in a Docker volume named `mint_data`. This ensures your mint state is preserved across container restarts.

## Render Deployment

This backend is configured for deployment on Render. Follow these steps:

### 1. Deploy to Render

1. **Connect your repository to Render:**
   - Go to [Render](https://render.com)
   - Create a new Web Service
   - Connect your GitHub repository
   - Render will automatically detect the `render.yaml` configuration

2. **Deploy:**
   - Render will automatically build and deploy your container using the Dockerfile
   - The mint API will be available at your Render URL
   - The LDK Node management interface will be available at `https://your-app-name.onrender.com:8091`

### 2. Render Configuration

The deployment uses:
- **Dockerfile**: Located in `/backend/Dockerfile`
- **Render config**: `render.yaml` (in root directory)
- **Ignore file**: `.renderignore` (excludes Kotlin files)

### 3. Environment Variables

Key environment variables for Render:
- `CDK_MINTD_URL`: Auto-generated by Render
- `CDK_MINTD_MNEMONIC`: Default test mnemonic (change for production)
- All other variables have sensible defaults

## Integration with Frontend

The mint server will be available at:
- **Local development**: `http://localhost:3338`
- **Render production**: `https://your-app-name.onrender.com`

## Secure Access to LDK Node Management Interface

The LDK Node management interface (port 8091) is not publicly accessible on Render for security reasons. Here are two ways to access it securely:

### Option 1: SSH Tunnel (Recommended)

Use the provided script to create a secure SSH tunnel:

```bash
# Run the access script
./access-management.sh

# Then open http://localhost:8091 in your browser
```

### Option 2: Management Proxy

Use the Python proxy server with basic authentication:

```bash
# Install Python dependencies (if needed)
pip install urllib3

# Run the proxy server
python3 backend/management-proxy.py

# Then open http://localhost:8080 in your browser
# Username: admin
# Password: mandel-secure-2024
```

**Security Note**: Change the default password in `management-proxy.py` before using in production!

## Persistent Storage

The LDK Node data is now configured to persist across deployments using Render's persistent disk feature. This means:

- ✅ **Channel state preserved** - Your Lightning channels won't be lost on redeploy
- ✅ **Node identity maintained** - Your node's private keys and identity persist
- ✅ **Transaction history kept** - All transaction data survives deployments

### Backup Node State

To create a backup of your node state:

```bash
# Create a backup
./backup-node-state.sh

# This will create a timestamped backup in the backups/ directory
```

### Restore Node State

If you need to restore from a backup:

```bash
# Extract backup to Render service
tar -xzf backups/ldk-node-YYYYMMDD-HHMMSS/mint-data.tar.gz -C /data/
```

### Data Location

- **Persistent data**: `/data/` (mounted disk)
- **Database file**: `/data/cdk-mintd.sqlite`
- **LDK Node data**: `/data/ldk_node_data/` (created automatically)
